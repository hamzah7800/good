<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Battle Prototype</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; color: white; }
        #hud { position: absolute; top: 10px; left: 10px; font-weight: bold; text-shadow: 2px 2px #000; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
        #loading { position: fixed; inset: 0; background: #111; color: #3b82f6; display: flex; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        
        /* Mobile Controls */
        #mobile-controls { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; padding: 0 40px; box-sizing: border-box; pointer-events: none; }
        .m-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; color: white; font-weight: bold; font-size: 12px; }
        #joystick-zone { position: absolute; bottom: 30px; left: 30px; width: 150px; height: 150px; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="loading"><h1>DOWNLOADING ASSETS...<br><span style="font-size: 14px; color: #888;">Ensure .glb files are in folder</span></h1></div>

    <div id="ui">
        <div id="hud">
            <div id="state-txt">PHASE: BUS</div>
            <div id="alt-txt">ALT: 0m</div>
        </div>
        <div id="crosshair"></div>
        <div id="mobile-controls">
            <div id="joy-placeholder"></div> <div style="display: flex; gap: 15px;">
                <div class="m-btn" id="m-jump">JUMP</div>
                <div class="m-btn" id="m-fire" style="background: rgba(255,0,0,0.3)">FIRE</div>
            </div>
        </div>
    </div>
    <div id="joystick-zone"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, clock, mixer;
        let player, bus, map, gun;
        let gameState = "BUS"; 
        let isGrounded = false;
        let velocity = new THREE.Vector3();
        let rockets = [];
        const keys = {};
        const raycaster = new THREE.Raycaster();
        let moveInput = { x: 0, y: 0 };

        async function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 500, 8000);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 30000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // FIX: Color Management for models
            renderer.outputColorSpace = THREE.SRGBColorSpace; 
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 1.5));
            const sun = new THREE.DirectionalLight(0xffffff, 2);
            sun.position.set(100, 1000, 100);
            scene.add(sun);

            const loader = new GLTFLoader();

            try {
                const [mD, bD, cD, gD] = await Promise.all([
                    loader.loadAsync('battle_guys_map.glb'),
                    loader.loadAsync('battle_bus.glb'),
                    loader.loadAsync('renegade_raider.glb'),
                    loader.loadAsync('rocket_gun.glb')
                ]);

                map = mD.scene;
                map.scale.setScalar(8); // Ultra large map
                scene.add(map);

                bus = bD.scene;
                bus.scale.setScalar(12);
                bus.position.set(0, 1200, 4000);
                scene.add(bus);

                player = new THREE.Group();
                const model = cD.scene;
                const box = new THREE.Box3().setFromObject(model);
                model.scale.setScalar(2.5 / box.getSize(new THREE.Vector3()).y);
                player.add(model);

                gun = gD.scene;
                gun.scale.setScalar(0.08); // Tiny realistic scale
                gun.position.set(0.4, 1.2, -0.4); 
                player.add(gun);
                scene.add(player);

                if (cD.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    mixer.clipAction(cD.animations[0]).play();
                }

                document.getElementById('loading').style.display = 'none';
                setupControls();
                clock = new THREE.Clock();
                animate();
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "<h1>ERROR: MODELS NOT FOUND</h1>";
            }
        }

        function setupControls() {
            // PC
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                handleAction(e.code);
            });
            window.addEventListener('keyup', (e) => keys[e.code] = false);
            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement) player.rotation.y -= e.movementX * 0.003;
            });
            window.addEventListener('mousedown', () => {
                if (!document.pointerLockElement) renderer.domElement.requestPointerLock();
                else fireRocket();
            });

            // Mobile Detect & Joystick
            if ('ontouchstart' in window) {
                document.getElementById('mobile-controls').style.display = 'flex';
                const manager = nipplejs.create({ zone: document.getElementById('joystick-zone'), mode: 'static', position: {left: '80px', bottom: '80px'} });
                manager.on('move', (v, data) => { moveInput.x = data.vector.x; moveInput.y = data.vector.y; });
                manager.on('end', () => { moveInput.x = 0; moveInput.y = 0; });
                
                document.getElementById('m-jump').addEventListener('touchstart', () => handleAction('Space'));
                document.getElementById('m-fire').addEventListener('touchstart', fireRocket);
                
                // Touch to Rotate
                window.addEventListener('touchmove', (e) => {
                    if (e.touches[0].clientX > window.innerWidth / 2) {
                        player.rotation.y -= e.touches[0].force * 0.1 || 0.05; 
                    }
                });
            }
        }

        function handleAction(code) {
            if (code === 'KeyF' || code === 'Space') {
                if (gameState === "BUS") gameState = "DIVING";
                else if (gameState === "DIVING") {
                    gameState = "GLIDING";
                    velocity.y = -8;
                } else if (isGrounded) {
                    velocity.y = 18;
                    isGrounded = false;
                }
            }
        }

        function fireRocket() {
            if (gameState !== "GROUNDED") return;
            const rocket = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1), new THREE.MeshBasicMaterial({color: 0xffaa00}));
            rocket.position.copy(player.position).add(new THREE.Vector3(0, 1.5, 0));
            rocket.rotation.copy(player.rotation);
            rocket.rotateX(Math.PI/2);
            rockets.push({ mesh: rocket, dir: new THREE.Vector3(0, 0, -1).applyQuaternion(player.quaternion), life: 3 });
            scene.add(rocket);
        }

        function update() {
            const dt = Math.min(clock.getDelta(), 0.03);
            if (!player) return;

            if (gameState === "BUS") {
                bus.position.z -= 100 * dt;
                player.position.copy(bus.position).y -= 10;
                camera.position.lerp(new THREE.Vector3(bus.position.x, bus.position.y+40, bus.position.z+100), 0.1);
                camera.lookAt(bus.position);
            } else {
                let grav = (gameState === "GLIDING") ? 6 : 45;
                velocity.y -= grav * dt;

                // Move Logic (PC + Mobile)
                const moveDir = new THREE.Vector3();
                if (keys['KeyW'] || moveInput.y > 0.1) moveDir.z -= 1;
                if (keys['KeyS'] || moveInput.y < -0.1) moveDir.z += 1;
                if (keys['KeyA'] || moveInput.x < -0.1) moveDir.x -= 1;
                if (keys['KeyD'] || moveInput.x > 0.1) moveDir.x += 1;
                moveDir.normalize().applyQuaternion(player.quaternion);

                let speed = (gameState === "GROUNDED") ? 25 : 60;
                // Friction / Damping for easier landing
                let damping = (moveDir.length() === 0) ? 10 : 2; 
                velocity.x = THREE.MathUtils.lerp(velocity.x, moveDir.x * speed, damping * dt);
                velocity.z = THREE.MathUtils.lerp(velocity.z, moveDir.z * speed, damping * dt);

                player.position.add(velocity.clone().multiplyScalar(dt));

                // Ground Check
                raycaster.set(player.position.clone().add(new THREE.Vector3(0, 2, 0)), new THREE.Vector3(0, -1, 0));
                const hits = raycaster.intersectObject(map, true);
                if (hits.length > 0 && hits[0].distance < 2.2) {
                    if (velocity.y < 0) {
                        player.position.y = hits[0].point.y;
                        velocity.y = 0;
                        isGrounded = true;
                        gameState = "GROUNDED";
                    }
                } else { isGrounded = false; }

                rockets.forEach((r, i) => {
                    r.mesh.position.add(r.dir.clone().multiplyScalar(120 * dt));
                    r.life -= dt;
                    if (r.life <= 0) { scene.remove(r.mesh); rockets.splice(i, 1); }
                });

                const camOff = new THREE.Vector3(0, 6, 18).applyQuaternion(player.quaternion);
                camera.position.lerp(player.position.clone().add(camOff), 0.1);
                camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 2, 0)));
            }
            document.getElementById('state-txt').innerText = `PHASE: ${gameState}`;
            document.getElementById('alt-txt').innerText = `ALT: ${Math.round(player.position.y)}m`;
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            if (mixer) mixer.update(0.016);
            renderer.render(scene, camera);
        }
        init();
    </script>
</body>
</html>